### 网关

网关往往是一个路由器，是一个三层转发的设备。用来连接不同的局域网，里面有如何寻找下一跳的规则；

### 网关的路由方式

- 静态路由

  就是在路由器上，配置一条一条规则

- 动态路由

  根据路由协议算法生成动态路由表



### 网关类型

MAC 地址是一个局域网内才有效的地址。MAC 地址只要过网关，就必定会改变，因为已经换了局域网。

两者主要的区别在于 IP 地址是否改变

- 转发网关

  不改变 IP 地址的网关

- NAT网关

  改变 IP 地址的网关



### 路由表

当一个入口的网络包送到路由器时，它会根据一个本地的转发信息库，来决定如何正确地转发流量。

一张路由表中会有多条路由规则。每一条规则至少包含这三项信息。

- 目的网络：这个包想去哪儿？
- 出口设备:  将包从哪个口扔出去？
- 下一跳网关：下一个路由器的地址。



## 静态路由



### 如何根据目标IP地址添加路由

```bash
 ip route add 10.176.48.0/20 via 10.173.32.1 dev eth0
```

去 10.176.48.0/20 这个目标网络，要从 eth0 端口出去，经过 10.173.32.1



### 如何根据规则添加路由

可以配置多个路由表，可以根据源 IP 地址、入口设备、TOS 等选择路由表，然后在路由表中查找路由。

```bash
ip rule add from 192.168.1.0/24 table 10 
ip rule add from 192.168.2.0/24 table 20
```



## 动态路由



### 算法

1. 距离矢量路由 基于 Bellman-Ford 算法的

   每个路由器保存全局路由信息，通过定时通知邻居来更新。

   - 优点
     - 简单
     - 好消息传得快 新增路由器的信息很快就同步了

   - 缺点
     - 坏消息传得慢 路由器坏了的时候其他路由器需要等到所有人都发现他下线了才知道
     - 每次发送的时候，要发送整个全局路由表

   只适合于小型网络（小于 15 跳）

2. 链路状态路由算法 基于 Dijkstra 算法

   当一个路由器启动的时候，首先是发现邻居，然后计算和邻居的距离，再将自己和邻居之间的链路状态包广播出去，发送到整个网络的每个路由器。这样每个路由器都能够收到它和邻居之间的关系的信息。因而，每个路由器都能在自己本地构建一个完整的图，然后针对这个图使用 Dijkstra 算法，找到两点之间的最短路径。



### 动态路由协议

1. 基于链路状态路由算法的 OSPF 

   Open Shortest Path First，开放式最短路径优先，主要用于数据中心内部，又被称为内部网关协议（Interior Gateway Protocol，简称 IGP）

   可以利用***等价路由***(多个最短路径)来进行负载均衡。

2.  基于距离矢量路由算法的 BGP

   外网路由协议（Border Gateway Protocol，简称 BGP。）

   - 自治系统  AS（Autonomous System

     - Stub AS

       对外只有一个连接。这类 AS 不会传输其他 AS 的包。例如，个人或者小公司的网络。

     - Multihomed AS

       可能有多个连接连到其他的 AS，但是大多拒绝帮其他的 AS 传输包。例如一些大公司的网络。

     - Transit AS

       有多个连接连到其他的 AS，并且可以帮助其他的 AS 传输包。例如主干网。

   - 分类

     - eBGP

       自治系统间，边界路由器之间使用 eBGP 广播路由。

     - iBGP

       iBGP使得内部的路由器能够找到到达外网目的地的最好的边界路由器。