### 哨兵是什么？

哨兵其实就是一个运行在特殊模式下的 Redis 进程，主从库实例运行的同时，它也在运行。用来实现在主库发生故障时，自动的主从切换是服务不间断的关键支撑。

哨兵主要负责的就是三个任务：

- 监控

  周期性地给所有的主从库发送 PING 命令，检测它们是否仍然在线运行。

- 选主

  主库挂了以后，哨兵就需要从很多个从库里，按照一定的规则选择一个从库实例，把它作为新的主库。

- 通知

  在执行通知任务时，哨兵会把新主库的连接信息发给其他从库，让它们执行 replicaof 命令，和新主库建立连接，并进行数据复制。同时，哨兵会把新主库的连接信息通知给客户端，让它们把请求操作发到新主库上。


### 哨兵怎么知道服务器下线了？

- 主观下线

  哨兵以每秒一次的频率向实例（主服务器，从服务器，其他哨兵）发送PING命令的回复来判断实例是否在线。如果在指定的时间内没有收到有效回复，就认为这个实例已经进入主观下线状态。

- 客观下线

  在确定了服务器主观下线以后，他会向同时监视这一服务器的其他哨兵询问是否它们也认为服务器已经下线。

  判断的标准是认为下线的哨兵数大于等于所有哨兵数/2 + 1。 



### 哨兵如何进行选取哪个Redis服务成为主服？

前提：

1. 服务器在线
2. 网络状态良好

选取优先级：

1. 优先级
2. 和旧主库同步程度
3. ID 号



### 哨兵怎么通信？

- 主库

  从配置文件知道主库地址和端口

- 从库

  向主库发送 INFO 命令来获取Redis的所有从库信息。

- 其它哨兵

  通过 Redis 提供的 pub/sub 机制，同时订阅主库的 \__sentinel__:hello 的频道来互相发现



### 哨兵集群由哪个哨兵执行主从切换？怎么选举哨兵 Leader？

当一个主服务器被判断为客观下线时，见识这个下线主服务器的各个哨兵，会进行协商，选举出一个领头哨兵，并由其进行故障转移操作。

规则是：

1. 机会均等
2. 纪元自增
3. 唯一设置领头
4. 先到先得
5. 半数以上

除此之外，哨兵拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值

### 

### [共识协议](https://juejin.cn/post/6907151199141625870)

- Raft

  应用：

  -  [etcd](https://github.com/etcd-io/etcd) 
  - [consul](https://github.com/hashicorp/consul)
  - [TiKV](https://github.com/tikv/tikv) 

  原理：

  - 选主（Leader election）
  - 日志复制（Log replication）
  - 安全性（Safety）

-  Paxos

  应用：

  - Chubby
  - ZoomKeeper

